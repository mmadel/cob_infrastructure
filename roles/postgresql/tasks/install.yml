---
- name: Install required packages
  apt:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
      - libpq-dev
    state: present
    update_cache: yes
  become: true
- name: Drop broken cluster if it exists
  shell: |
    pg_lsclusters | grep '^14\s\+main' && pg_dropcluster --stop 14 main || true
  args:
    executable: /bin/bash
  become: true
- name: Create default cluster for PostgreSQL 14 if not present
  shell: pg_createcluster 14 main --start
  args:
    creates: /var/lib/postgresql/14/main
  become: true
- name: Ensure PostgreSQL service is started and enabled
  service:
    name: postgresql
    state: started
    enabled: true
  become: true
