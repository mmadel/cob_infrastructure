---
- name: Install PostgreSQL packages
  apt:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
      - libpq-dev
    state: present
    update_cache: yes
  become: true

# âœ… Check for config and data dir
- name: Check if config dir exists
  stat:
    path: /etc/postgresql/14/main
  register: pg_conf_dir
  become: true

- name: Check if data dir exists
  stat:
    path: /var/lib/postgresql/14/main
  register: pg_data_dir
  become: true

# ðŸ§ª Check if cluster is ONLINE (exists and running)
- name: Check if PostgreSQL cluster is online
  shell: |
    pg_lsclusters | grep -q "^14\s\+main\s\+[0-9]\+\s\+online"
  register: cluster_status
  changed_when: false
  failed_when: false
  become: true

# ðŸ§¹ If config exists and data is missing or not online, delete both
- name: Remove broken cluster dirs
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/postgresql/14/main
    - /var/lib/postgresql/14/main
  when: >
    pg_conf_dir.stat.exists and
    (not pg_data_dir.stat.exists or cluster_status.rc != 0)
  become: true

# âœ… Create cluster only if not online
- name: Create PostgreSQL 14 cluster if not already online
  shell: |
    pg_createcluster 14 main --start -- --auth-local=trust
  args:
    creates: /etc/postgresql/14/main
  when: cluster_status.rc != 0
  become: true

- name: Ensure PostgreSQL service is enabled and running
  service:
    name: postgresql
    state: started
    enabled: true
  become: true
