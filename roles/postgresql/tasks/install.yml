---
- name: Install required packages
  apt:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
      - libpq-dev
    state: present
    update_cache: yes
  become: true

# ğŸ§ª Check if the cluster config directory exists
- name: Check if cluster config directory exists
  stat:
    path: /etc/postgresql/14/main
  register: pg_conf_dir
  become: true

# ğŸ§ª Check if the data directory exists
- name: Check if cluster data directory exists
  stat:
    path: /var/lib/postgresql/14/main
  register: pg_data_dir
  become: true

# ğŸ§¹ Remove cluster ONLY if config exists but data directory is missing (broken cluster)
- name: Remove broken PostgreSQL cluster config and data
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/postgresql/14/main
    - /var/lib/postgresql/14/main
  when:
    - pg_conf_dir.stat.exists
    - not pg_data_dir.stat.exists
  become: true

# ğŸ› ï¸ Create the cluster if data dir doesn't exist (safe to re-run)
- name: Create PostgreSQL 14 cluster if not present
  shell: pg_createcluster 14 main --start
  args:
    creates: /var/lib/postgresql/14/main
  become: true

# ğŸ” Optional: Debug cluster status
- name: Show PostgreSQL clusters
  shell: pg_lsclusters
  register: pg_clusters
  become: true

- name: Print cluster list
  debug:
    var: pg_clusters.stdout_lines

# â–¶ï¸ Ensure PostgreSQL service is running and enabled
- name: Ensure PostgreSQL service is started and enabled
  service:
    name: postgresql
    state: started
    enabled: true
  become: true
